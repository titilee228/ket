<style type="text/css">
    /* ==========================================
   è®¾ç½®é¢æ¿æ ·å¼
   ========================================== */

.settings-modal {
    max-width: 450px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: var(--spacing-md);
}

.modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-500);
    padding: 0;
    line-height: 1;
}

.modal-close:hover {
    color: var(--gray-800);
}

.setting-group {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--gray-100);
}

.setting-group:last-child {
    border-bottom: none;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
}

.setting-item.setting-sub {
    padding-left: var(--spacing-lg);
    opacity: 0.9;
}

.setting-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.95rem;
}

.setting-icon {
    font-size: 1.1rem;
}

.setting-control {
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    background: var(--white);
    font-size: 0.9rem;
}

/* å¼€å…³æ ·å¼ */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--gray-300);
    transition: 0.3s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(22px);
}

/* éŸ³é‡æ§åˆ¶ */
.volume-control {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.volume-control input[type="range"] {
    width: 100px;
}

#volume-display {
    font-size: 0.85rem;
    color: var(--gray-600);
    min-width: 40px;
}

/* æŒ‰é’® */
.btn-full {
    width: 100%;
    justify-content: center;
}

.btn-danger {
    background: var(--error-color);
    color: white;
}

.btn-danger:hover {
    background: #E53935;
}

.modal-footer {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--gray-100);
    text-align: center;
}

.version-info {
    font-size: 0.8rem;
    color: var(--gray-500);
    margin: 0;
}

</style>
<!-- è®¾ç½®æŒ‰é’® -->
<button id="btn-settings" class="btn btn-icon" data-i18n-title="buttons.settings">
    âš™ï¸
</button>

<!-- è®¾ç½®é¢æ¿å¼¹çª— -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal settings-modal">
        <div class="modal-header">
            <h2 data-i18n="settings.title">è®¾ç½®</h2>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- è¯­è¨€è®¾ç½® -->
            <div class="setting-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">ğŸŒ</span>
                        <span data-i18n="settings.language">è¯­è¨€</span>
                    </div>
                    <select id="setting-language" class="setting-control">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                    </select>
                </div>
            </div>
            
            <!-- éŸ³æ•ˆè®¾ç½® -->
            <div class="setting-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">ğŸ”Š</span>
                        <span data-i18n="settings.sound">éŸ³æ•ˆ</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-sound">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-item setting-sub" id="volume-setting">
                    <div class="setting-label">
                        <span data-i18n="settings.soundVolume">éŸ³é‡</span>
                    </div>
                    <div class="volume-control">
                        <input type="range" id="setting-volume" min="0" max="100" value="70">
                        <span id="volume-display">70%</span>
                    </div>
                </div>
            </div>
            
            <!-- æ˜¾ç¤ºè®¾ç½® -->
            <div class="setting-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">âœ¨</span>
                        <span data-i18n="settings.animations">åŠ¨ç”»æ•ˆæœ</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-animations">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">ğŸŒ™</span>
                        <span data-i18n="settings.darkMode">æ·±è‰²æ¨¡å¼</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-dark-mode">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">â±ï¸</span>
                        <span data-i18n="settings.showTimer">æ˜¾ç¤ºè®¡æ—¶å™¨</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-timer">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- æ¸¸æˆè®¾ç½® -->
            <div class="setting-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon">âœ“</span>
                        <span data-i18n="settings.autoCheck">è‡ªåŠ¨æ£€æŸ¥</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-auto-check">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç† -->
            <div class="setting-group">
                <div class="setting-item">
                    <button id="btn-view-stats" class="btn btn-secondary btn-full">
                        <span>ğŸ“Š</span>
                        <span data-i18n="buttons.statistics">ç»Ÿè®¡æ•°æ®</span>
                    </button>
                </div>
                
                <div class="setting-item">
                    <button id="btn-export-data" class="btn btn-secondary btn-full">
                        <span>ğŸ“¤</span>
                        <span>å¯¼å‡ºæ•°æ®</span>
                    </button>
                </div>
                
                <div class="setting-item">
                    <button id="btn-reset-stats" class="btn btn-danger btn-full">
                        <span>ğŸ—‘ï¸</span>
                        <span data-i18n="statistics.reset">é‡ç½®ç»Ÿè®¡</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <p class="version-info">ç‰ˆæœ¬ 1.0.0</p>
        </div>
    </div>
</div>
<script type="text/javascript">
    /**
 * è®¾ç½®é¢æ¿æ§åˆ¶å™¨
 */
const SettingsController = {
    /**
     * åˆå§‹åŒ–
     */
    init() {
        this._bindEvents();
        this._loadSettings();
    },
    
    /**
     * ç»‘å®šäº‹ä»¶
     */
    _bindEvents() {
        // æ‰“å¼€è®¾ç½®
        document.getElementById('btn-settings')?.addEventListener('click', () => {
            this.open();
        });
        
        // å…³é—­è®¾ç½®
        document.querySelectorAll('[data-close-modal]').forEach(btn => {
            btn.addEventListener('click', () => {
                this.close();
            });
        });
        
        // ç‚¹å‡»é®ç½©å…³é—­
        document.getElementById('settings-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                this.close();
            }
        });
        
        // è¯­è¨€åˆ‡æ¢
        document.getElementById('setting-language')?.addEventListener('change', (e) => {
            I18n.setLanguage(e.target.value);
        });
        
        // éŸ³æ•ˆå¼€å…³
        document.getElementById('setting-sound')?.addEventListener('change', (e) => {
            AudioManager.setEnabled(e.target.checked);
            document.getElementById('volume-setting').style.display = 
                e.target.checked ? 'flex' : 'none';
        });
        
        // éŸ³é‡è°ƒèŠ‚
        document.getElementById('setting-volume')?.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            AudioManager.setVolume(volume);
            document.getElementById('volume-display').textContent = e.target.value + '%';
        });
        
        // åŠ¨ç”»å¼€å…³
        document.getElementById('setting-animations')?.addEventListener('change', (e) => {
            AnimationManager.setEnabled(e.target.checked);
            StorageManager.setSetting('animationsEnabled', e.target.checked);
        });
        
        // æ·±è‰²æ¨¡å¼
        document.getElementById('setting-dark-mode')?.addEventListener('change', (e) => {
            ThemeManager.setDark(e.target.checked);
        });
        
        // æ˜¾ç¤ºè®¡æ—¶å™¨
        document.getElementById('setting-timer')?.addEventListener('change', (e) => {
            StorageManager.setSetting('showTimer', e.target.checked);
            document.querySelector('.status-item:has(#timer)').style.display = 
                e.target.checked ? 'flex' : 'none';
        });
        
        // è‡ªåŠ¨æ£€æŸ¥
        document.getElementById('setting-auto-check')?.addEventListener('change', (e) => {
            StorageManager.setSetting('autoCheck', e.target.checked);
        });
        
        // æŸ¥çœ‹ç»Ÿè®¡
        document.getElementById('btn-view-stats')?.addEventListener('click', () => {
            this.close();
            StatisticsController.open();
        });
        
        // å¯¼å‡ºæ•°æ®
        document.getElementById('btn-export-data')?.addEventListener('click', () => {
            const data = StorageManager.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crossword_data.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // é‡ç½®ç»Ÿè®¡
        document.getElementById('btn-reset-stats')?.addEventListener('click', () => {
            if (confirm(I18n.t('statistics.resetConfirm'))) {
                StorageManager.resetStatistics();
                AudioManager.play('click');
            }
        });
    },
    
    /**
     * åŠ è½½è®¾ç½®åˆ°UI
     */
    _loadSettings() {
        const settings = StorageManager.loadSettings();
        
        // è¯­è¨€
        const langSelect = document.getElementById('setting-language');
        if (langSelect) langSelect.value = settings.language;
        
        // éŸ³æ•ˆ
        const soundCheck = document.getElementById('setting-sound');
        if (soundCheck) soundCheck.checked = settings.soundEnabled;
        
        // éŸ³é‡
        const volumeRange = document.getElementById('setting-volume');
        if (volumeRange) {
            volumeRange.value = settings.soundVolume * 100;
            document.getElementById('volume-display').textContent = 
                Math.round(settings.soundVolume * 100) + '%';
        }
        
        // éŸ³é‡è®¾ç½®æ˜¾ç¤º
        const volumeSetting = document.getElementById('volume-setting');
        if (volumeSetting) {
            volumeSetting.style.display = settings.soundEnabled ? 'flex' : 'none';
        }
        
        // åŠ¨ç”»
        const animCheck = document.getElementById('setting-animations');
        if (animCheck) animCheck.checked = settings.animationsEnabled;
        
        // æ·±è‰²æ¨¡å¼
        const darkCheck = document.getElementById('setting-dark-mode');
        if (darkCheck) darkCheck.checked = settings.darkMode;
        
        // è®¡æ—¶å™¨
        const timerCheck = document.getElementById('setting-timer');
        if (timerCheck) timerCheck.checked = settings.showTimer;
        
        // è‡ªåŠ¨æ£€æŸ¥
        const autoCheck = document.getElementById('setting-auto-check');
        if (autoCheck) autoCheck.checked = settings.autoCheck;
    },
    
    /**
     * æ‰“å¼€è®¾ç½®é¢æ¿
     */
    open() {
        this._loadSettings();
        document.getElementById('settings-modal')?.classList.add('active');
        AudioManager.play('click');
    },
    
    /**
     * å…³é—­è®¾ç½®é¢æ¿
     */
    close() {
        document.getElementById('settings-modal')?.classList.remove('active');
    }
};
    
</script>