<style type="text/css">
  
  /* éŸ³æ•ˆæ§åˆ¶æ ·å¼ */
.audio-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    border-radius: 50%;
    background: var(--gray-100);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-icon:hover {
    background: var(--gray-200);
    transform: scale(1.1);
}

.btn-icon.muted {
    opacity: 0.5;
}

.sound-icon {
    transition: transform var(--transition-fast);
}

.sound-icon.hidden {
    display: none;
}

.volume-slider-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--white);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
}

.volume-slider {
    width: 80px;
    height: 4px;
    -webkit-appearance: none;
    background: var(--gray-300);
    border-radius: 2px;
    outline: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--primary-color);
    border-radius: 50%;
    cursor: pointer;
}

#volume-value {
    font-size: 0.75rem;
    color: var(--gray-600);
    min-width: 35px;
}
</style><!-- éŸ³æ•ˆæ§åˆ¶æŒ‰é’® -->
<div class="audio-controls">
    <button id="btn-sound-toggle" class="btn btn-icon" title="éŸ³æ•ˆå¼€å…³">
        <span class="sound-icon sound-on">ğŸ”Š</span>
        <span class="sound-icon sound-off hidden">ğŸ”‡</span>
    </button>
    
    <div class="volume-slider-container hidden">
        <input type="range" 
               id="volume-slider" 
               class="volume-slider" 
               min="0" 
               max="100" 
               value="70">
        <span id="volume-value">70%</span>
    </div>
</div>
<script type="text/javascript">
  /**
 * ==========================================
 * éŸ³æ•ˆç®¡ç†å™¨
 * ==========================================
 */

const AudioManager = {
    // éŸ³æ•ˆé…ç½®
    sounds: {
        keyPress: { src: null, volume: 0.3 },
        correct: { src: null, volume: 0.5 },
        incorrect: { src: null, volume: 0.4 },
        complete: { src: null, volume: 0.6 },
        click: { src: null, volume: 0.2 },
        hint: { src: null, volume: 0.4 },
        levelUp: { src: null, volume: 0.5 }
    },
    
    // çŠ¶æ€
    enabled: true,
    masterVolume: 0.7,
    audioContext: null,
    
    /**
     * åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
     */
    init() {
        // å°è¯•åˆ›å»º AudioContext
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.warn('Web Audio API ä¸æ”¯æŒï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
        }
        
        // ç”ŸæˆéŸ³æ•ˆï¼ˆä½¿ç”¨ Web Audio API åˆæˆï¼‰
        this._generateSounds();
        
        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤è®¾ç½®
        this._loadSettings();
        
        // è§£é”éŸ³é¢‘ï¼ˆç§»åŠ¨ç«¯éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
        this._setupAudioUnlock();
    },
    
    /**
     * ç”ŸæˆåˆæˆéŸ³æ•ˆ
     */
    _generateSounds() {
        // æŒ‰é”®éŸ³ - çŸ­ä¿ƒçš„ç‚¹å‡»å£°
        this.sounds.keyPress.play = () => this._playTone(800, 0.05, 'sine');
        
        // æ­£ç¡®éŸ³ - ä¸Šå‡çš„åŒéŸ³
        this.sounds.correct.play = () => {
            this._playTone(523, 0.1, 'sine'); // C5
            setTimeout(() => this._playTone(659, 0.15, 'sine'), 100); // E5
        };
        
        // é”™è¯¯éŸ³ - ä½æ²‰çš„å—¡å—¡å£°
        this.sounds.incorrect.play = () => {
            this._playTone(200, 0.2, 'sawtooth', 0.3);
        };
        
        // å®ŒæˆéŸ³ - æ¬¢å¿«çš„ä¸Šå‡éŸ³é˜¶
        this.sounds.complete.play = () => {
            const notes = [523, 587, 659, 698, 784, 880, 988, 1047]; // C5 åˆ° C6
            notes.forEach((freq, i) => {
                setTimeout(() => this._playTone(freq, 0.15, 'sine'), i * 80);
            });
        };
        
        // ç‚¹å‡»éŸ³
        this.sounds.click.play = () => this._playTone(600, 0.03, 'sine');
        
        // æç¤ºéŸ³ - æŸ”å’Œçš„æç¤º
        this.sounds.hint.play = () => {
            this._playTone(440, 0.1, 'sine');
            setTimeout(() => this._playTone(550, 0.1, 'sine'), 100);
        };
        
        // å‡çº§éŸ³
        this.sounds.levelUp.play = () => {
            const notes = [392, 494, 587, 784]; // G4, B4, D5, G5
            notes.forEach((freq, i) => {
                setTimeout(() => this._playTone(freq, 0.2, 'triangle'), i * 120);
            });
        };
    },
    
    /**
     * ä½¿ç”¨ Web Audio API æ’­æ”¾éŸ³è°ƒ
     */
    _playTone(frequency, duration, type = 'sine', volume = null) {
        if (!this.enabled || !this.audioContext) return;
        
        try {
            // ç¡®ä¿ AudioContext å¤„äºè¿è¡ŒçŠ¶æ€
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
            
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
            
            const vol = (volume !== null ? volume : 0.3) * this.masterVolume;
            gainNode.gain.setValueAtTime(vol, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
                0.001, 
                this.audioContext.currentTime + duration
            );
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + duration);
        } catch (e) {
            console.warn('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
        }
    },
    
    /**
     * æ’­æ”¾æŒ‡å®šéŸ³æ•ˆ
     */
    play(soundName) {
        if (!this.enabled) return;
        
        const sound = this.sounds[soundName];
        if (sound && sound.play) {
            sound.play();
        }
    },
    
    /**
     * è®¾ç½®å¯ç”¨/ç¦ç”¨
     */
    setEnabled(enabled) {
        this.enabled = enabled;
        this._saveSettings();
    },
    
    /**
     * åˆ‡æ¢å¯ç”¨çŠ¶æ€
     */
    toggle() {
        this.enabled = !this.enabled;
        this._saveSettings();
        return this.enabled;
    },
    
    /**
     * è®¾ç½®ä¸»éŸ³é‡
     */
    setVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
        this._saveSettings();
    },
    
    /**
     * ç§»åŠ¨ç«¯éŸ³é¢‘è§£é”
     */
    _setupAudioUnlock() {
        const unlock = () => {
            if (this.audioContext && this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
            
            // æ’­æ”¾é™éŸ³æ¥è§£é”
            this._playTone(1, 0.001, 'sine', 0);
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬
            document.removeEventListener('touchstart', unlock);
            document.removeEventListener('click', unlock);
        };
        
        document.addEventListener('touchstart', unlock, { once: true });
        document.addEventListener('click', unlock, { once: true });
    },
    
    /**
     * ä¿å­˜è®¾ç½®
     */
    _saveSettings() {
        try {
            localStorage.setItem('audio_settings', JSON.stringify({
                enabled: this.enabled,
                masterVolume: this.masterVolume
            }));
        } catch (e) {
            console.warn('ä¿å­˜éŸ³æ•ˆè®¾ç½®å¤±è´¥');
        }
    },
    
    /**
     * åŠ è½½è®¾ç½®
     */
    _loadSettings() {
        try {
            const saved = localStorage.getItem('audio_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                this.enabled = settings.enabled ?? true;
                this.masterVolume = settings.masterVolume ?? 0.7;
            }
        } catch (e) {
            console.warn('åŠ è½½éŸ³æ•ˆè®¾ç½®å¤±è´¥');
        }
    }
};

// å¯¼å‡ºæˆ–æŒ‚è½½åˆ°å…¨å±€
if (typeof module !== 'undefined' && module.exports) {
    module.exports = AudioManager;
}
</script>